steps:
  # ğŸ§ª BUILD APP
  build:
    image: python:3.12-slim
    commands:
      - echo "ğŸ”§ Installing dependencies..."
      - apt-get update && apt-get install -y gcc && rm -rf /var/lib/apt/lists/*
      - echo "ğŸ“¦ Installing base dependencies..."
      - pip install --timeout 1000 --retries 5 -r requirements-base.txt
      - echo "ğŸ” Installing auth dependencies..."
      - pip install --timeout 1000 --retries 5 -r requirements-auth.txt
      - echo "ğŸ—ƒï¸ Installing database dependencies..."
      - pip install --timeout 1000 --retries 5 -r requirements-db.txt
      - echo "ğŸ”§ Installing utility dependencies..."
      - pip install --timeout 1000 --retries 5 -r requirements-utils.txt
      - echo "ğŸ¤– Installing ML dependencies..."
      - pip install --timeout 1000 --retries 5 -r requirements-ml.txt
      - echo "ğŸ—ï¸ Building app..."
      - python setup.py build || echo "No setup.py found, skipping..."
      - echo "âœ… Build complete"

  # ğŸš€ DEPLOY APP
  deploy:
    image: docker/compose:latest
    commands:
      - echo "ğŸš€ Deploying app to host filesystem..."
      - rm -rf /mnt/deploy/*
      - cp -r ./* /mnt/deploy/
      - echo "ğŸ§¹ Stopping and removing old containers..."
      - docker stop receipts-backend receipts-frontend receipts || true
      - docker rm receipts-backend receipts-frontend receipts || true
      - echo "ğŸ“¦ Running docker-compose from /mnt/deploy..."
      - docker compose -f /mnt/deploy/docker-compose.yml down || true
      - docker compose -f /mnt/deploy/docker-compose.yml up -d --build
      - echo "âœ… Deployment complete!"

  # ğŸ§¹ CLEANUP
  cleanup:
    image: docker/compose:latest
    commands:
      - docker compose down --remove-orphans || true
      - docker system prune -f || true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    when:
      branch: master
